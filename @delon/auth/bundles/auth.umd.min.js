/**
 * @license ng-alain(cipchk@qq.com) v11.3.1
 * (c) 2020 cipchk https://ng-alain.com/
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/core"),require("rxjs"),require("@delon/util"),require("rxjs/operators"),require("@angular/router"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("@delon/auth",["exports","@angular/common","@angular/core","rxjs","@delon/util","rxjs/operators","@angular/router","@angular/common/http"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).delon=e.delon||{},e.delon.auth={}),e.ng.common,e.ng.core,e.rxjs,e.delon.util,e.rxjs.operators,e.ng.router,e.ng.common.http)}(this,(function(e,t,n,r,o,i,a,u){"use strict";var s={store_key:"_token",token_invalid_redirect:!0,token_exp_offset:10,token_send_key:"token",token_send_template:"${token}",token_send_place:"header",login_url:"/login",ignores:[/\/login/,/assets\//,/passport\//],allow_anonymous_key:"_allow_anonymous",executeOtherInterceptors:!0,refreshTime:3e3,refreshOffset:6e3};function c(e){return e.merge("auth",s)}function l(){return new f}var f=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(localStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return localStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){localStorage.removeItem(e)},e}(),p=new n.InjectionToken("AUTH_STORE_TOKEN",{providedIn:"root",factory:l});function h(){return new d(n.inject(o.AlainConfigService),n.inject(p))}var d=function(){function e(e,t){this.store=t,this.refresh$=new r.Subject,this.change$=new r.BehaviorSubject(null),this._referrer={},this._options=c(e)}return Object.defineProperty(e.prototype,"refresh",{get:function(){return this.builderRefresh(),this.refresh$.pipe(i.share())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"login_url",{get:function(){return this._options.login_url},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"referrer",{get:function(){return this._referrer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.prototype.set=function(e){return this.change$.next(e),this.store.set(this._options.store_key,e)},e.prototype.get=function(e){var t=this.store.get(this._options.store_key);return e?Object.assign(new e,t):t},e.prototype.clear=function(e){void 0===e&&(e={onlyToken:!1});var t=null;!0===e.onlyToken?((t=this.get()).token="",this.set(t)):this.store.remove(this._options.store_key),this.change$.next(t)},e.prototype.change=function(){return this.change$.pipe(i.share())},e.prototype.builderRefresh=function(){var e=this,t=this._options,n=t.refreshTime,o=t.refreshOffset;this.cleanRefresh(),this.interval$=r.interval(n).pipe(i.map((function(){var t=e.get(),n=t.expired||t.exp||0;return n<=0?null:n<=(new Date).valueOf()+o?t:null})),i.filter((function(e){return null!=e}))).subscribe((function(t){return e.refresh$.next(t)}))},e.prototype.cleanRefresh=function(){this.interval$&&!this.interval$.closed&&this.interval$.unsubscribe()},e.prototype.ngOnDestroy=function(){this.cleanRefresh()},e}();d.ɵfac=function(e){return new(e||d)(n.ɵɵinject(o.AlainConfigService),n.ɵɵinject(p))},d.ɵprov=n.ɵɵdefineInjectable({token:d,factory:d.ɵfac}),("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(d,[{type:n.Injectable}],(function(){return[{type:o.AlainConfigService},{type:void 0,decorators:[{type:n.Inject,args:[p]}]}]}),null);var g=new n.InjectionToken("DA_SERVICE_TOKEN",{providedIn:"root",factory:h}),y="_delonAuthSocialType",v="_delonAuthSocialCallbackByHref",m=function(){function e(e,t,n){this.tokenService=e,this.doc=t,this.router=n}return e.prototype.login=function(e,t,n){var o=this;if(void 0===t&&(t="/"),void 0===n&&(n={}),n=Object.assign({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},n),localStorage.setItem(y,n.type),localStorage.setItem(v,t),"href"!==n.type)return this._win=window.open(e,"_blank",n.windowFeatures),this._winTime=setInterval((function(){if(o._win&&o._win.closed){o.ngOnDestroy();var e=o.tokenService.get();e&&!e.token&&(e=null),e&&o.tokenService.set(e),o.observer.next(e),o.observer.complete()}}),100),new r.Observable((function(e){o.observer=e}));this.doc.location.href=e},e.prototype.callback=function(e){if(!e&&-1===this.router.url.indexOf("?"))throw new Error("url muse contain a ?");var t={token:""};if("string"==typeof e){var n=e.split("?")[1].split("#")[0];t=this.router.parseUrl("./?"+n).queryParams}else t=e;if(!t||!t.token)throw new Error("invalide token data");this.tokenService.set(t);var r=localStorage.getItem(v)||"/";localStorage.removeItem(v);var o=localStorage.getItem(y);return localStorage.removeItem(y),"window"===o?window.close():this.router.navigateByUrl(r),t},e.prototype.ngOnDestroy=function(){clearInterval(this._winTime),this._winTime=null},e}();m.ɵfac=function(e){return new(e||m)(n.ɵɵinject(g),n.ɵɵinject(t.DOCUMENT),n.ɵɵinject(a.Router))},m.ɵprov=n.ɵɵdefineInjectable({token:m,factory:m.ɵfac}),("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(m,[{type:n.Injectable}],(function(){return[{type:void 0,decorators:[{type:n.Inject,args:[g]}]},{type:void 0,decorators:[{type:n.Inject,args:[t.DOCUMENT]}]},{type:a.Router}]}),null);var _=function(){function e(){this.cache={}}return e.prototype.get=function(e){return this.cache[e]||{}},e.prototype.set=function(e,t){return this.cache[e]=t,!0},e.prototype.remove=function(e){this.cache[e]=null},e}(),b=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(sessionStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return sessionStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){sessionStorage.removeItem(e)},e}(),j=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(Cookies.get(e)||"{}")||{}},e.prototype.set=function(e,t){return Cookies.set(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){Cookies.remove(e)},e}(),w=function(e,t){return(w=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function I(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}w(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}Object.create;function k(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}Object.create;function S(e){return null!=e&&"string"==typeof e.token&&e.token.length>0}function O(e,t){return null!=e&&!!e.token&&!e.isExpired(t)}function T(e,n,r){var o=n.get(a.Router);n.get(g).referrer.url=r||o.url,!0===e.token_invalid_redirect&&setTimeout((function(){/^https?:\/\//g.test(e.login_url)?n.get(t.DOCUMENT).location.href=e.login_url:o.navigate([e.login_url])}))}var C=function(){function e(e,t){this.next=e,this.interceptor=t}return e.prototype.handle=function(e){return this.interceptor.intercept(e,this.next)},e}(),A=function(){function e(e){this.injector=e}return e.prototype.intercept=function(e,t){var n,i,a=c(this.injector.get(o.AlainConfigService));if(Array.isArray(a.ignores))try{for(var s=k(a.ignores),l=s.next();!l.done;l=s.next()){if(l.value.test(e.url))return t.handle(e)}}catch(e){n={error:e}}finally{try{l&&!l.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}var f=a.allow_anonymous_key,p=!1,h=e.params,d=e.url;e.params.has(f)&&(h=e.params.delete(f),p=!0);var g=e.url.split("?");if(g.length>1){var y=new u.HttpParams({fromString:g[1]});if(y.has(f)){var v=y.delete(f).toString();d=v.length>0?g[0]+"?"+v:g[0],p=!0}}if(p)return t.handle(e.clone({params:h,url:d}));if(!this.isAuth(a)){T(a,this.injector);var m=new r.Observable((function(t){var n=new u.HttpErrorResponse({url:e.url,headers:e.headers,status:401,statusText:"来自 @delon/auth 的拦截，所请求URL未授权，若是登录API可加入 [url?_allow_anonymous=true] 来表示忽略校验，更多方法请参考： https://ng-alain.com/auth/getting-started#AlainAuthConfig\nThe interception from @delon/auth, the requested URL is not authorized. If the login API can add [url?_allow_anonymous=true] to ignore the check, please refer to: https://ng-alain.com/auth/getting-started#AlainAuthConfig"});t.error(n)}));if(a.executeOtherInterceptors){var _=this.injector.get(u.HTTP_INTERCEPTORS,[]),b=_.slice(_.indexOf(this)+1);if(b.length>0)return b.reduceRight((function(e,t){return new C(e,t)}),{handle:function(e){return m}}).handle(e)}return m}return e=this.setReq(e,a),t.handle(e)},e}();function x(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("'atob' failed: The string to be decoded is not correctly encoded.")}return function(e){return decodeURIComponent(Array.prototype.map.call(function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="";e=String(e).replace(/=+$/,"");for(var r=0,o=void 0,i=void 0,a=0;i=e.charAt(a++);~i&&(o=r%4?64*o+i:i,r++%4)?n+=String.fromCharCode(255&o>>(-2*r&6)):0)i=t.indexOf(i);return n}(e),(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}(t)}A.ɵfac=function(e){return new(e||A)(n.ɵɵinject(n.Injector,8))},A.ɵprov=n.ɵɵdefineInjectable({token:A,factory:A.ɵfac}),("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(A,[{type:n.Injectable}],(function(){return[{type:n.Injector,decorators:[{type:n.Optional}]}]}),null);var M=function(){function e(){}return Object.defineProperty(e.prototype,"payload",{get:function(){var e=(this.token||"").split(".");if(3!==e.length)throw new Error("JWT must have 3 parts");var t=x(e[1]);return JSON.parse(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"exp",{get:function(){var e=this.payload;if(!e.hasOwnProperty("exp"))return null;var t=new Date(0);return t.setUTCSeconds(e.exp),t.valueOf()},enumerable:!1,configurable:!0}),e.prototype.isExpired=function(e){void 0===e&&(e=0);var t=this.exp;return null==t?null:!(t>(new Date).valueOf()+1e3*e)},e}(),D=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return I(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(g).get(M),O(this.model,e.token_exp_offset)},t.prototype.setReq=function(e,t){return e.clone({setHeaders:{Authorization:"Bearer "+this.model.token}})},t}(A);D.ɵfac=function(e){return E(e||D)},D.ɵprov=n.ɵɵdefineInjectable({token:D,factory:D.ɵfac});var E=n.ɵɵgetInheritedFactory(D);("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(D,[{type:n.Injectable}],null,null);var R=function(){function e(e,t){this.srv=e,this.injector=t}return Object.defineProperty(e.prototype,"cog",{get:function(){return this.srv.options},enumerable:!1,configurable:!0}),e.prototype.process=function(){var e=O(this.srv.get(M),this.cog.token_exp_offset);return e||T(this.cog,this.injector,this.url),e},e.prototype.canLoad=function(e,t){return this.url=e.path,this.process()},e.prototype.canActivateChild=function(e,t){return this.url=t.url,this.process()},e.prototype.canActivate=function(e,t){return this.url=t.url,this.process()},e}();R.ɵfac=function(e){return new(e||R)(n.ɵɵinject(g),n.ɵɵinject(n.Injector))},R.ɵprov=n.ɵɵdefineInjectable({token:R,factory:R.ɵfac,providedIn:"root"}),("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(R,[{type:n.Injectable,args:[{providedIn:"root"}]}],(function(){return[{type:void 0,decorators:[{type:n.Inject,args:[g]}]},{type:n.Injector}]}),null);var N=function(){},P=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return I(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(g).get(),S(this.model)},t.prototype.setReq=function(e,t){var n=this,r=t.token_send_template,o=t.token_send_key,i=r.replace(/\$\{([\w]+)\}/g,(function(e,t){return n.model[t]}));switch(t.token_send_place){case"header":var a={};a[o]=i,e=e.clone({setHeaders:a});break;case"body":var u=e.body||{};u[o]=i,e=e.clone({body:u});break;case"url":e=e.clone({params:e.params.append(o,i)})}return e},t}(A);P.ɵfac=function(e){return $(e||P)},P.ɵprov=n.ɵɵdefineInjectable({token:P,factory:P.ɵfac});var $=n.ɵɵgetInheritedFactory(P);("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(P,[{type:n.Injectable}],null,null);var q=function(){function e(e,t){this.srv=e,this.injector=t}return Object.defineProperty(e.prototype,"cog",{get:function(){return this.srv.options},enumerable:!1,configurable:!0}),e.prototype.process=function(){var e=S(this.srv.get());return e||T(this.cog,this.injector,this.url),e},e.prototype.canLoad=function(e,t){return this.url=e.path,this.process()},e.prototype.canActivateChild=function(e,t){return this.url=t.url,this.process()},e.prototype.canActivate=function(e,t){return this.url=t.url,this.process()},e}();q.ɵfac=function(e){return new(e||q)(n.ɵɵinject(g),n.ɵɵinject(n.Injector))},q.ɵprov=n.ɵɵdefineInjectable({token:q,factory:q.ɵfac,providedIn:"root"}),("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(q,[{type:n.Injectable,args:[{providedIn:"root"}]}],(function(){return[{type:void 0,decorators:[{type:n.Inject,args:[g]}]},{type:n.Injector}]}),null);var U=function(){};U.ɵmod=n.ɵɵdefineNgModule({type:U}),U.ɵinj=n.ɵɵdefineInjector({factory:function(e){return new(e||U)}}),("undefined"==typeof ngDevMode||ngDevMode)&&n.ɵsetClassMetadata(U,[{type:n.NgModule,args:[{}]}],null,null),e.AUTH_DEFAULT_CONFIG=s,e.BaseInterceptor=A,e.CookieStorageStore=j,e.DA_SERVICE_TOKEN=g,e.DA_SERVICE_TOKEN_FACTORY=h,e.DA_STORE_TOKEN=p,e.DA_STORE_TOKEN_LOCAL_FACTORY=l,e.DelonAuthModule=U,e.JWTGuard=R,e.JWTInterceptor=D,e.JWTTokenModel=M,e.LocalStorageStore=f,e.MemoryStore=_,e.SessionStorageStore=b,e.SimpleGuard=q,e.SimpleInterceptor=P,e.SimpleTokenModel=N,e.SocialService=m,e.TokenService=d,e.mergeConfig=c,e.urlBase64Decode=x,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=auth.umd.min.js.map