/**
 * @license ng-alain(cipchk@qq.com) v7.0.0-rc.0
 * (c) 2018 Cipchk https://ng-alain.com/
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/operators"),require("@angular/common/http"),require("rxjs"),require("@delon/theme"),require("@angular/common"),require("@angular/router"),require("@angular/core")):"function"==typeof define&&define.amd?define("@delon/auth",["exports","rxjs/operators","@angular/common/http","rxjs","@delon/theme","@angular/common","@angular/router","@angular/core"],t):t((e.delon=e.delon||{},e.delon.auth={}),e.rxjs.operators,e.ng.common.http,e.rxjs,e.delon.theme,e.ng.common,e.ng.router,e.ng.core)}(this,function(e,t,l,p,f,n,r,o){"use strict";var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function c(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var h=function(){return(h=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};var d=function(){function e(){this.store_key="_token",this.token_invalid_redirect=!0,this.token_exp_offset=10,this.token_send_key="token",this.token_send_template="${token}",this.token_send_place="header",this.login_url="/login",this.ignores=[/\/login/,/assets\//,/passport\//],this.allow_anonymous_key="_allow_anonymous"}return e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ngInjectableDef=o.defineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}();function a(){return new s}var s=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(localStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return localStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){localStorage.removeItem(e)},e}(),u=new o.InjectionToken("AUTH_STORE_TOKEN",{providedIn:"root",factory:a});function y(){return new g(o.inject(d),o.inject(u))}var g=function(){function e(e,t){this.options=e,this.store=t,this.change$=new p.BehaviorSubject(null)}return Object.defineProperty(e.prototype,"login_url",{get:function(){return this.options.login_url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"redirect",{get:function(){return this._redirect||"/"},set:function(e){this._redirect=e},enumerable:!0,configurable:!0}),e.prototype.set=function(e){return this.change$.next(e),this.store.set(this.options.store_key,e)},e.prototype.get=function(e){var t=this.store.get(this.options.store_key);return e?Object.assign(new e,t):t},e.prototype.clear=function(){this.change$.next(null),this.store.remove(this.options.store_key)},e.prototype.change=function(){return this.change$.pipe(t.share())},e.ctorParameters=function(){return[{type:d},{type:undefined,decorators:[{type:o.Inject,args:[u]}]}]},e}(),v=new o.InjectionToken("DA_SERVICE_TOKEN",{providedIn:"root",factory:y}),_="_delonAuthSocialType",m="_delonAuthSocialCallbackByHref",j=function(){function e(e,t,n){this.tokenService=e,this.doc=t,this.router=n}return e.prototype.login=function(e,t,n){var r=this;if(void 0===t&&(t="/"),void 0===n&&(n={}),n=h({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},n),localStorage.setItem(_,n.type),localStorage.setItem(m,t),"href"!==n.type)return this._win=window.open(e,"_blank",n.windowFeatures),this._winTime=setInterval(function(){if(r._win&&r._win.closed){r.ngOnDestroy();var e=r.tokenService.get();e&&!e.token&&(e=null),e&&r.tokenService.set(e),r.observer.next(e),r.observer.complete()}},100),p.Observable.create(function(e){r.observer=e});this.doc.location.href=e},e.prototype.callback=function(e){if(!e&&-1===this.router.url.indexOf("?"))throw new Error("url muse contain a ?");var t={token:""};if("string"==typeof e){var n=e.split("?")[1].split("#")[0];t=this.router.parseUrl("./?"+n).queryParams}else t=e;if(!t||!t.token)throw new Error("invalide token data");this.tokenService.set(t);var r=localStorage.getItem(m)||"/";localStorage.removeItem(m);var o=localStorage.getItem(_);return localStorage.removeItem(_),"window"===o?window.close():this.router.navigateByUrl(r),t},e.prototype.ngOnDestroy=function(){clearInterval(this._winTime),this._winTime=null},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:undefined,decorators:[{type:o.Inject,args:[v]}]},{type:undefined,decorators:[{type:o.Inject,args:[n.DOCUMENT]}]},{type:r.Router}]},e}(),k=function(){function e(){this.cache={}}return e.prototype.get=function(e){return this.cache[e]||{}},e.prototype.set=function(e,t){return this.cache[e]=t,!0},e.prototype.remove=function(e){this.cache[e]=null},e}(),w=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(sessionStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return sessionStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){sessionStorage.removeItem(e)},e}();function I(e){return null!=e&&"string"==typeof e.token&&0<e.token.length}function b(e,t){return null!=e&&e.token&&!e.isExpired(t)}function S(e,t){!0===e.token_invalid_redirect&&setTimeout(function(){/^https?:\/\//g.test(e.login_url)?t.get(n.DOCUMENT).location.href=e.login_url:t.get(r.Router).navigate([e.login_url])})}var O=function(){function e(e){this.injector=e}return e.prototype.intercept=function(n,e){var t,r,o=h({},new d,this.injector.get(d,null));if(o.ignores)try{for(var i=function s(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(o.ignores),c=i.next();!c.done;c=i.next()){if(c.value.test(n.url))return e.handle(n)}}catch(u){t={error:u}}finally{try{c&&!c.done&&(r=i["return"])&&r.call(i)}finally{if(t)throw t.error}}if(o.allow_anonymous_key&&(n.params.has(o.allow_anonymous_key)||new RegExp("[?|&]"+o.allow_anonymous_key+"=[^&]+").test(n.urlWithParams)))return e.handle(n);if(this.isAuth(o))return n=this.setReq(n,o),e.handle(n);S(o,this.injector);var a=this.injector.get(f._HttpClient,null);return a&&a.end(),new p.Observable(function(e){var t=new l.HttpErrorResponse({url:n.url,headers:n.headers,status:401,statusText:"From Auth Intercept --\x3e https://ng-alain.com/docs/auth"});e.error(t)})},e.ctorParameters=function(){return[{type:o.Injector,decorators:[{type:o.Optional}]}]},e}();function T(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("'atob' failed: The string to be decoded is not correctly encoded.")}return function n(e){return decodeURIComponent(Array.prototype.map.call(function c(e){var t="";e=String(e).replace(/=+$/,"");for(var n=0,r=void 0,o=void 0,i=0;o=e.charAt(i++);~o&&(r=n%4?64*r+o:o,n++%4)?t+=String.fromCharCode(255&r>>(-2*n&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return t}(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}(t)}var x=function(){function e(){}return Object.defineProperty(e.prototype,"payload",{get:function(){var e=(this.token||"").split(".");if(3!==e.length)throw new Error("JWT must have 3 parts");var t=T(e[1]);return JSON.parse(t)},enumerable:!0,configurable:!0}),e.prototype.isExpired=function(e){void 0===e&&(e=0);var t=this.payload;if(!t.hasOwnProperty("exp"))return null;var n=new Date(0);return n.setUTCSeconds(t.exp),!(n.valueOf()>(new Date).valueOf()+1e3*e)},e}(),E=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(v).get(x),b(this.model,e.token_exp_offset)},t.prototype.setReq=function(e,t){return e.clone({setHeaders:{Authorization:"Bearer "+this.model.token}})},t.decorators=[{type:o.Injectable}],t}(O),A=function(){function e(e,t,n){this.srv=e,this.injector=t,this.cog=h({},new d,n)}return e.prototype.process=function(){var e=b(this.srv.get(x),this.cog.token_exp_offset);return e||S(this.cog,this.injector),e},e.prototype.canLoad=function(){return this.process()},e.prototype.canActivateChild=function(){return this.process()},e.prototype.canActivate=function(){return this.process()},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:undefined,decorators:[{type:o.Inject,args:[v]}]},{type:o.Injector},{type:d}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(v),o.inject(o.INJECTOR),o.inject(d))},token:e,providedIn:"root"}),e}(),C=function P(){},R=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(v).get(),I(this.model)},t.prototype.setReq=function(e,t){var n=this,r=t.token_send_template.replace(/\$\{([\w]+)\}/g,function(e,t){return n.model[t]});switch(t.token_send_place){case"header":var o={};o[t.token_send_key]=r,e=e.clone({setHeaders:o});break;case"body":var i=e.body||{};i[t.token_send_key]=r,e=e.clone({body:i});break;case"url":e=e.clone({params:e.params.append(t.token_send_key,r)})}return e},t.decorators=[{type:o.Injectable}],t}(O),D=function(){function e(e,t,n){this.srv=e,this.injector=t,this.cog=h({},new d,n)}return e.prototype.process=function(){var e=I(this.srv.get());return e||S(this.cog,this.injector),e},e.prototype.canLoad=function(){return this.process()},e.prototype.canActivateChild=function(){return this.process()},e.prototype.canActivate=function(){return this.process()},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:undefined,decorators:[{type:o.Inject,args:[v]}]},{type:o.Injector},{type:d}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(v),o.inject(o.INJECTOR),o.inject(d))},token:e,providedIn:"root"}),e}(),N=function(){function e(){}return e.decorators=[{type:o.NgModule,args:[{}]}],e}();e.SocialService=j,e.DA_STORE_TOKEN=u,e.DA_STORE_TOKEN_LOCAL_FACTORY=a,e.LocalStorageStore=s,e.MemoryStore=k,e.SessionStorageStore=w,e.BaseInterceptor=O,e.DA_SERVICE_TOKEN=v,e.DA_SERVICE_TOKEN_FACTORY=y,e.TokenService=g,e.urlBase64Decode=T,e.JWTTokenModel=x,e.JWTInterceptor=E,e.JWTGuard=A,e.SimpleTokenModel=C,e.SimpleInterceptor=R,e.SimpleGuard=D,e.DelonAuthConfig=d,e.DelonAuthModule=N,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=auth.umd.min.js.map