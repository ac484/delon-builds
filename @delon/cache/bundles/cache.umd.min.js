/**
 * @license ng-alain(cipchk@qq.com) v9.4.0
 * (c) 2020 cipchk https://ng-alain.com/
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/common/http"),require("@angular/core"),require("@delon/util"),require("date-fns/addSeconds"),require("rxjs"),require("rxjs/operators"),require("@angular/cdk/platform")):"function"==typeof define&&define.amd?define("@delon/cache",["exports","@angular/common/http","@angular/core","@delon/util","date-fns/addSeconds","rxjs","rxjs/operators","@angular/cdk/platform"],e):e(((t=t||self).delon=t.delon||{},t.delon.cache={}),t.ng.common.http,t.ng.core,t.delon.util,t.addSeconds,t.rxjs,t.rxjs.operators,t.ng.cdk.platform)}(this,(function(t,e,r,o,i,n,s,f){"use strict";i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;var a=function(){return(a=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};var u=new r.InjectionToken("DC_STORE_STORAGE_TOKEN",{providedIn:"root",factory:function(){return new p(r.inject(f.Platform))}}),p=function(){function t(t){this.platform=t}return t.prototype.get=function(t){return this.platform.isBrowser&&JSON.parse(localStorage.getItem(t)||"null")||null},t.prototype.set=function(t,e){return!this.platform.isBrowser||(localStorage.setItem(t,JSON.stringify(e)),!0)},t.prototype.remove=function(t){this.platform.isBrowser&&localStorage.removeItem(t)},t}();var c=function(){function t(t,e,r){this.store=e,this.http=r,this.memory=new Map,this.notifyBuffer=new Map,this.meta=new Set,this.freqTick=3e3,this.cog=t.merge("cache",{mode:"promise",reName:"",prefix:"",meta_key:"__cache_meta"}),this.loadMeta(),this.startExpireNotify()}return t.prototype.deepGet=function(t,e,r){if(!t)return r;if(e.length<=1){var o=e.length?t[e[0]]:t;return void 0===o?r:o}return e.reduce((function(t,e){return t[e]}),t)||r},t.prototype.pushMeta=function(t){this.meta.has(t)||(this.meta.add(t),this.saveMeta())},t.prototype.removeMeta=function(t){this.meta.has(t)&&(this.meta.delete(t),this.saveMeta())},t.prototype.loadMeta=function(){var t=this,e=this.store.get(this.cog.meta_key);e&&e.v&&e.v.forEach((function(e){return t.meta.add(e)}))},t.prototype.saveMeta=function(){var t=[];this.meta.forEach((function(e){return t.push(e)})),this.store.set(this.cog.meta_key,{v:t,e:0})},t.prototype.getMeta=function(){return this.meta},t.prototype.set=function(t,e,r){var o=this;void 0===r&&(r={});var f=0,u=this.cog,p=u.type,c=u.expire;if((r=a({type:p,expire:c},r)).expire&&(f=i(new Date,r.expire).valueOf()),e instanceof n.Observable)return e.pipe(s.tap((function(e){o.save(r.type,t,{v:e,e:f})})));this.save(r.type,t,{v:e,e:f})},t.prototype.save=function(t,e,r){"m"===t?this.memory.set(e,r):(this.store.set(this.cog.prefix+e,r),this.pushMeta(e)),this.runNotify(e,"set")},t.prototype.get=function(t,e){var r=this;void 0===e&&(e={});var o="none"!==e.mode&&"promise"===this.cog.mode,i=this.memory.has(t)?this.memory.get(t):this.store.get(this.cog.prefix+t);return!i||i.e&&i.e>0&&i.e<(new Date).valueOf()?o?this.http.get(t).pipe(s.map((function(t){return r.deepGet(t,r.cog.reName,null)})),s.tap((function(o){return r.set(t,o,{type:e.type,expire:e.expire})}))):null:o?n.of(i.v):i.v},t.prototype.getNone=function(t){return this.get(t,{mode:"none"})},t.prototype.tryGet=function(t,e,r){void 0===r&&(r={});var o=this.getNone(t);return null===o?e instanceof n.Observable?this.set(t,e,r):(this.set(t,e,r),e):n.of(o)},t.prototype.has=function(t){return this.memory.has(t)||this.meta.has(t)},t.prototype._remove=function(t,e){e&&this.runNotify(t,"remove"),this.memory.has(t)?this.memory.delete(t):(this.store.remove(this.cog.prefix+t),this.removeMeta(t))},t.prototype.remove=function(t){this._remove(t,!0)},t.prototype.clear=function(){var t=this;this.notifyBuffer.forEach((function(e,r){return t.runNotify(r,"remove")})),this.memory.clear(),this.meta.forEach((function(e){return t.store.remove(t.cog.prefix+e)}))},Object.defineProperty(t.prototype,"freq",{set:function(t){this.freqTick=Math.max(20,t),this.abortExpireNotify(),this.startExpireNotify()},enumerable:!0,configurable:!0}),t.prototype.startExpireNotify=function(){this.checkExpireNotify(),this.runExpireNotify()},t.prototype.runExpireNotify=function(){var t=this;this.freqTime=setTimeout((function(){t.checkExpireNotify(),t.runExpireNotify()}),this.freqTick)},t.prototype.checkExpireNotify=function(){var t=this,e=[];this.notifyBuffer.forEach((function(r,o){t.has(o)&&null===t.getNone(o)&&e.push(o)})),e.forEach((function(e){t.runNotify(e,"expire"),t._remove(e,!1)}))},t.prototype.abortExpireNotify=function(){clearTimeout(this.freqTime)},t.prototype.runNotify=function(t,e){this.notifyBuffer.has(t)&&this.notifyBuffer.get(t).next({type:e,value:this.getNone(t)})},t.prototype.notify=function(t){if(!this.notifyBuffer.has(t)){var e=new n.BehaviorSubject(this.getNone(t));this.notifyBuffer.set(t,e)}return this.notifyBuffer.get(t).asObservable()},t.prototype.cancelNotify=function(t){this.notifyBuffer.has(t)&&(this.notifyBuffer.get(t).unsubscribe(),this.notifyBuffer.delete(t))},t.prototype.hasNotify=function(t){return this.notifyBuffer.has(t)},t.prototype.clearNotify=function(){this.notifyBuffer.forEach((function(t){return t.unsubscribe()})),this.notifyBuffer.clear()},t.prototype.ngOnDestroy=function(){this.memory.clear(),this.abortExpireNotify(),this.clearNotify()},t.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:o.AlainConfigService},{type:void 0,decorators:[{type:r.Inject,args:[u]}]},{type:e.HttpClient}]},t.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(o.AlainConfigService),r.ɵɵinject(u),r.ɵɵinject(e.HttpClient))},token:t,providedIn:"root"}),t}();var h=function(){function t(){}return t.decorators=[{type:r.NgModule,args:[{}]}],t}();t.CacheService=c,t.DelonCacheModule=h,t.ɵa=u,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=cache.umd.min.js.map