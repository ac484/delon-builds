/**
 * @license ng-alain(cipchk@qq.com) v11.3.1
 * (c) 2020 cipchk https://ng-alain.com/
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("date-fns/addSeconds"),require("rxjs"),require("rxjs/operators"),require("@angular/cdk/platform"),require("@delon/util/config"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("@delon/cache",["exports","@angular/core","date-fns/addSeconds","rxjs","rxjs/operators","@angular/cdk/platform","@delon/util/config","@angular/common/http"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).delon=e.delon||{},e.delon.cache={}),e.ng.core,e.addSeconds,e.rxjs,e.rxjs.operators,e.ng.cdk.platform,e.i1,e.ng.common.http)}(this,(function(e,t,o,r,i,n,f,s){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=a(o),c=new t.InjectionToken("DC_STORE_STORAGE_TOKEN",{providedIn:"root",factory:function(){return new p(t.inject(n.Platform))}}),p=function(){function e(e){this.platform=e}return e.prototype.get=function(e){return this.platform.isBrowser&&JSON.parse(localStorage.getItem(e)||"null")||null},e.prototype.set=function(e,t){return!this.platform.isBrowser||(localStorage.setItem(e,JSON.stringify(t)),!0)},e.prototype.remove=function(e){this.platform.isBrowser&&localStorage.removeItem(e)},e}(),h=function(){function e(e,t,o){this.store=t,this.http=o,this.memory=new Map,this.notifyBuffer=new Map,this.meta=new Set,this.freqTick=3e3,this.cog=e.merge("cache",{mode:"promise",reName:"",prefix:"",meta_key:"__cache_meta"}),this.loadMeta(),this.startExpireNotify()}return e.prototype.deepGet=function(e,t,o){if(!e)return o;if(t.length<=1){var r=t.length?e[t[0]]:e;return void 0===r?o:r}return t.reduce((function(e,t){return e[t]}),e)||o},e.prototype.pushMeta=function(e){this.meta.has(e)||(this.meta.add(e),this.saveMeta())},e.prototype.removeMeta=function(e){this.meta.has(e)&&(this.meta.delete(e),this.saveMeta())},e.prototype.loadMeta=function(){var e=this,t=this.store.get(this.cog.meta_key);t&&t.v&&t.v.forEach((function(t){return e.meta.add(t)}))},e.prototype.saveMeta=function(){var e=[];this.meta.forEach((function(t){return e.push(t)})),this.store.set(this.cog.meta_key,{v:e,e:0})},e.prototype.getMeta=function(){return this.meta},e.prototype.set=function(e,t,o){var n=this;void 0===o&&(o={});var f=0,s=this.cog,a=s.type,c=s.expire;if((o=Object.assign({type:a,expire:c},o)).expire&&(f=u.default(new Date,o.expire).valueOf()),t instanceof r.Observable)return t.pipe(i.tap((function(t){n.save(o.type,e,{v:t,e:f})})));this.save(o.type,e,{v:t,e:f})},e.prototype.save=function(e,t,o){"m"===e?this.memory.set(t,o):(this.store.set(this.cog.prefix+t,o),this.pushMeta(t)),this.runNotify(t,"set")},e.prototype.get=function(e,t){var o=this;void 0===t&&(t={});var n="none"!==t.mode&&"promise"===this.cog.mode,f=this.memory.has(e)?this.memory.get(e):this.store.get(this.cog.prefix+e);return!f||f.e&&f.e>0&&f.e<(new Date).valueOf()?n?this.http.get(e).pipe(i.map((function(e){return o.deepGet(e,o.cog.reName,null)})),i.tap((function(r){return o.set(e,r,{type:t.type,expire:t.expire})}))):null:n?r.of(f.v):f.v},e.prototype.getNone=function(e){return this.get(e,{mode:"none"})},e.prototype.tryGet=function(e,t,o){void 0===o&&(o={});var i=this.getNone(e);return null===i?t instanceof r.Observable?this.set(e,t,o):(this.set(e,t,o),t):r.of(i)},e.prototype.has=function(e){return this.memory.has(e)||this.meta.has(e)},e.prototype._remove=function(e,t){t&&this.runNotify(e,"remove"),this.memory.has(e)?this.memory.delete(e):(this.store.remove(this.cog.prefix+e),this.removeMeta(e))},e.prototype.remove=function(e){this._remove(e,!0)},e.prototype.clear=function(){var e=this;this.notifyBuffer.forEach((function(t,o){return e.runNotify(o,"remove")})),this.memory.clear(),this.meta.forEach((function(t){return e.store.remove(e.cog.prefix+t)}))},Object.defineProperty(e.prototype,"freq",{set:function(e){this.freqTick=Math.max(20,e),this.abortExpireNotify(),this.startExpireNotify()},enumerable:!1,configurable:!0}),e.prototype.startExpireNotify=function(){this.checkExpireNotify(),this.runExpireNotify()},e.prototype.runExpireNotify=function(){var e=this;this.freqTime=setTimeout((function(){e.checkExpireNotify(),e.runExpireNotify()}),this.freqTick)},e.prototype.checkExpireNotify=function(){var e=this,t=[];this.notifyBuffer.forEach((function(o,r){e.has(r)&&null===e.getNone(r)&&t.push(r)})),t.forEach((function(t){e.runNotify(t,"expire"),e._remove(t,!1)}))},e.prototype.abortExpireNotify=function(){clearTimeout(this.freqTime)},e.prototype.runNotify=function(e,t){this.notifyBuffer.has(e)&&this.notifyBuffer.get(e).next({type:t,value:this.getNone(e)})},e.prototype.notify=function(e){if(!this.notifyBuffer.has(e)){var t=new r.BehaviorSubject(this.getNone(e));this.notifyBuffer.set(e,t)}return this.notifyBuffer.get(e).asObservable()},e.prototype.cancelNotify=function(e){this.notifyBuffer.has(e)&&(this.notifyBuffer.get(e).unsubscribe(),this.notifyBuffer.delete(e))},e.prototype.hasNotify=function(e){return this.notifyBuffer.has(e)},e.prototype.clearNotify=function(){this.notifyBuffer.forEach((function(e){return e.unsubscribe()})),this.notifyBuffer.clear()},e.prototype.ngOnDestroy=function(){this.memory.clear(),this.abortExpireNotify(),this.clearNotify()},e}();h.ɵfac=function(e){return new(e||h)(t.ɵɵinject(f.AlainConfigService),t.ɵɵinject(c),t.ɵɵinject(s.HttpClient))},h.ɵprov=t.ɵɵdefineInjectable({token:h,factory:h.ɵfac,providedIn:"root"}),("undefined"==typeof ngDevMode||ngDevMode)&&t.ɵsetClassMetadata(h,[{type:t.Injectable,args:[{providedIn:"root"}]}],(function(){return[{type:f.AlainConfigService},{type:void 0,decorators:[{type:t.Inject,args:[c]}]},{type:s.HttpClient}]}),null);var y=function(){};y.ɵmod=t.ɵɵdefineNgModule({type:y}),y.ɵinj=t.ɵɵdefineInjector({factory:function(e){return new(e||y)}}),("undefined"==typeof ngDevMode||ngDevMode)&&t.ɵsetClassMetadata(y,[{type:t.NgModule,args:[{}]}],null,null),e.CacheService=h,e.DelonCacheModule=y,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=cache.umd.min.js.map