{"version":3,"file":"downFile.js.map","sources":["ng://@delon/abc/down-file/down-file.directive.ts","ng://@delon/abc/down-file/down-file.module.ts"],"sourcesContent":["import {\r\n  Directive,\r\n  ElementRef,\r\n  Input,\r\n  HostListener,\r\n  EventEmitter,\r\n  Output,\r\n  Optional,\r\n} from '@angular/core';\r\nimport { HttpResponse, HttpClient } from '@angular/common/http';\r\nimport { saveAs } from 'file-saver';\r\nimport { _HttpClient } from '@delon/theme';\r\n\r\n/**\r\n * æä»¶ä¸è½½\r\n *\r\n * ```html\r\n * <button nz-button down-file http-url=\"assets/demo{{i}}\" file-name=\"demoä¸­æ\">{{i}}</button>\r\n * ```\r\n */\r\n@Directive({ selector: '[down-file]' })\r\nexport class DownFileDirective {\r\n  /** URLè¯·æ±åæ° */\r\n  @Input('http-data')\r\n  httpData: any;\r\n  /** è¯·æ±ç±»å */\r\n  @Input('http-method')\r\n  httpMethod: string = 'get';\r\n  /** ä¸è½½å°å */\r\n  @Input('http-url')\r\n  httpUrl: string;\r\n  /** æå®æä»¶åï¼è¥ä¸ºç©ºä»æå¡ç«¯è¿åç `header` ä¸­è·å `filename`ã`x-filename` */\r\n  @Input('file-name')\r\n  fileName: string;\r\n  /** æååè° */\r\n  @Output()\r\n  success: EventEmitter<HttpResponse<Blob>> = new EventEmitter<HttpResponse<Blob>>();\r\n  /** éè¯¯åè° */\r\n  @Output()\r\n  error: EventEmitter<any> = new EventEmitter<any>();\r\n\r\n  private getDisposition(data: string) {\r\n    const arr: any = (data || '')\r\n      .split(';')\r\n      .filter(i => i.includes('='))\r\n      .map(v => {\r\n        const strArr = v.split('=');\r\n        const utfId = `UTF-8''`;\r\n        let value = strArr[1];\r\n        if (value.startsWith(utfId)) value = value.substr(utfId.length);\r\n        return { [strArr[0].trim()]: value };\r\n      });\r\n    return arr.reduce((o, item: any) => item, {});\r\n  }\r\n\r\n  constructor(\r\n    private el: ElementRef,\r\n    private http: HttpClient,\r\n    @Optional() private _http: _HttpClient,\r\n  ) {}\r\n\r\n  @HostListener('click')\r\n  _click() {\r\n    this.el.nativeElement.disabled = true;\r\n    ((this._http || this.http) as any)\r\n      .request(this.httpMethod, this.httpUrl, {\r\n        params: this.httpData || {},\r\n        responseType: 'blob',\r\n        observe: 'response',\r\n      })\r\n      .subscribe(\r\n        (res: HttpResponse<Blob>) => {\r\n          if (res.status !== 200 || res.body.size <= 0) {\r\n            this.error.emit(res);\r\n            return;\r\n          }\r\n          const disposition: any = this.getDisposition(\r\n            res.headers.get('content-disposition'),\r\n          );\r\n          const fileName =\r\n            this.fileName ||\r\n            disposition[`filename*`] ||\r\n            disposition[`filename`] ||\r\n            res.headers.get('filename') ||\r\n            res.headers.get('x-filename');\r\n          saveAs(res.body, decodeURI(fileName));\r\n          this.success.emit(res);\r\n          this.el.nativeElement.disabled = false;\r\n        },\r\n        err => {\r\n          this.error.emit(err);\r\n          this.el.nativeElement.disabled = false;\r\n        },\r\n      );\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { AlainThemeModule } from '@delon/theme';\r\n\r\nimport { DownFileDirective } from './down-file.directive';\r\n\r\nconst DIRECTIVES = [DownFileDirective];\r\n\r\n@NgModule({\r\n  imports: [CommonModule, AlainThemeModule],\r\n  declarations: [...DIRECTIVES],\r\n  exports: [...DIRECTIVES],\r\n})\r\nexport class DownFileModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return { ngModule: DownFileModule, providers: [] };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
