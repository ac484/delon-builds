{"version":3,"file":"downFile.js.map","sources":["ng://@delon/abc/down-file/down-file.directive.ts","ng://@delon/abc/down-file/down-file.module.ts"],"sourcesContent":["import { HttpClient, HttpResponse } from '@angular/common/http';\nimport {\n  Directive,\n  ElementRef,\n  EventEmitter,\n  HostListener,\n  Input,\n  Optional,\n  Output,\n} from '@angular/core';\nimport { _HttpClient } from '@delon/theme';\nimport { saveAs } from 'file-saver';\n\n/**\n * æä»¶ä¸è½½\n *\n * ```html\n * <button nz-button down-file http-url=\"assets/demo{{i}}\" file-name=\"demoä¸­æ\">{{i}}</button>\n * ```\n */\n@Directive({ selector: '[down-file]' })\nexport class DownFileDirective {\n  /** URLè¯·æ±åæ° */\n  @Input('http-data')\n  httpData: {};\n  /** è¯·æ±ç±»å */\n  @Input('http-method')\n  httpMethod: string = 'get';\n  /** ä¸è½½å°å */\n  @Input('http-url')\n  httpUrl: string;\n  /** æå®æä»¶åï¼è¥ä¸ºç©ºä»æå¡ç«¯è¿åç `header` ä¸­è·å `filename`ã`x-filename` */\n  @Input('file-name')\n  fileName: string;\n  /** æååè° */\n  @Output()\n  readonly success = new EventEmitter<HttpResponse<Blob>>();\n  /** éè¯¯åè° */\n  @Output()\n  readonly error = new EventEmitter<{}>();\n\n  private getDisposition(data: string) {\n    // tslint:disable-next-line:no-any\n    const arr: any[] = (data || '')\n      .split(';')\n      .filter(i => i.includes('='))\n      .map(v => {\n        const strArr = v.split('=');\n        const utfId = `UTF-8''`;\n        let value = strArr[1];\n        if (value.startsWith(utfId)) value = value.substr(utfId.length);\n        return { [strArr[0].trim()]: value };\n      });\n    // tslint:disable-next-line:no-any\n    return arr.reduce((o, item: any) => item, {});\n  }\n\n  constructor(\n    private el: ElementRef,\n    private http: HttpClient,\n    @Optional() private _http: _HttpClient,\n  ) { }\n\n  @HostListener('click')\n  _click() {\n    this.el.nativeElement.disabled = true;\n    // tslint:disable-next-line:no-any\n    ((this._http || this.http) as any)\n      .request(this.httpMethod, this.httpUrl, {\n        params: this.httpData || {},\n        responseType: 'blob',\n        observe: 'response',\n      })\n      .subscribe(\n        (res: HttpResponse<Blob>) => {\n          if (res.status !== 200 || res.body.size <= 0) {\n            this.error.emit(res);\n            return;\n          }\n          const disposition = this.getDisposition(\n            res.headers.get('content-disposition'),\n          );\n          const fileName =\n            this.fileName ||\n            disposition[`filename*`] ||\n            disposition[`filename`] ||\n            res.headers.get('filename') ||\n            res.headers.get('x-filename');\n          saveAs(res.body, decodeURI(fileName));\n          this.success.emit(res);\n          this.el.nativeElement.disabled = false;\n        },\n        err => {\n          this.error.emit(err);\n          this.el.nativeElement.disabled = false;\n        },\n      );\n  }\n}\n","import { CommonModule } from '@angular/common';\nimport { ModuleWithProviders, NgModule } from '@angular/core';\nimport { AlainThemeModule } from '@delon/theme';\n\nimport { DownFileDirective } from './down-file.directive';\n\nconst DIRECTIVES = [DownFileDirective];\n\n@NgModule({\n  imports: [CommonModule, AlainThemeModule],\n  declarations: [...DIRECTIVES],\n  exports: [...DIRECTIVES],\n})\nexport class DownFileModule {\n  static forRoot(): ModuleWithProviders {\n    return { ngModule: DownFileModule, providers: [] };\n  }\n}\n"],"names":[],"mappings":"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"}
