{"version":3,"file":"downFile.js","sources":["ng://@delon/abc/down-file/down-file.directive.ts","ng://@delon/abc/down-file/down-file.module.ts"],"sourcesContent":["import { HttpResponse } from '@angular/common/http';\nimport { Directive, ElementRef, EventEmitter, Input, Output } from '@angular/core';\nimport { _HttpClient } from '@delon/theme';\nimport { saveAs } from 'file-saver';\nimport { NzSafeAny } from 'ng-zorro-antd/core/types';\n\n@Directive({\n  selector: '[down-file]',\n  exportAs: 'downFile',\n  host: {\n    '(click)': '_click()',\n  },\n})\nexport class DownFileDirective {\n  private isFileSaverSupported = true;\n  /** URL请求参数 */\n  @Input('http-data') httpData: {};\n  /** URL请求参数 */\n  @Input('http-body') httpBody: {};\n  /** 请求类型 */\n  @Input('http-method') httpMethod: string = 'get';\n  /** 下载地址 */\n  @Input('http-url') httpUrl: string;\n  /** 指定文件名，若为空从服务端返回的 `header` 中获取 `filename`、`x-filename` */\n  @Input('file-name') fileName: string | ((rep: HttpResponse<Blob>) => string);\n  /** 成功回调 */\n  // tslint:disable-next-line:no-output-native\n  @Output() readonly success = new EventEmitter<HttpResponse<Blob>>();\n  /** 错误回调 */\n  // tslint:disable-next-line:no-output-native\n  @Output() readonly error = new EventEmitter<any>();\n\n  private getDisposition(data: string | null): NzSafeAny {\n    const arr: Array<{}> = (data || '')\n      .split(';')\n      .filter(i => i.includes('='))\n      .map(v => {\n        const strArr = v.split('=');\n        const utfId = `UTF-8''`;\n        let value = strArr[1];\n        if (value.startsWith(utfId)) value = value.substr(utfId.length);\n        return { [strArr[0].trim()]: value };\n      });\n    return arr.reduce((_o, item) => item, {});\n  }\n\n  constructor(private el: ElementRef<HTMLButtonElement>, private _http: _HttpClient) {\n    let isFileSaverSupported = false;\n    try {\n      isFileSaverSupported = !!new Blob();\n    } catch {}\n    this.isFileSaverSupported = isFileSaverSupported;\n    if (!isFileSaverSupported) {\n      el.nativeElement.classList.add(`down-file__not-support`);\n    }\n  }\n\n  private setDisabled(status: boolean): void {\n    const el = this.el.nativeElement;\n    el.disabled = status;\n    el.classList[status ? 'add' : 'remove'](`down-file__disabled`);\n  }\n\n  _click() {\n    if (!this.isFileSaverSupported) {\n      return;\n    }\n    this.setDisabled(true);\n    this._http\n      .request(this.httpMethod, this.httpUrl, {\n        params: this.httpData || {},\n        responseType: 'blob',\n        observe: 'response',\n        body: this.httpBody,\n      })\n      .subscribe(\n        (res: HttpResponse<Blob>) => {\n          if (res.status !== 200 || res.body!.size <= 0) {\n            this.error.emit(res);\n            return;\n          }\n          const disposition = this.getDisposition(res.headers.get('content-disposition'));\n          let fileName = this.fileName;\n          if (typeof fileName === 'function') fileName = fileName(res);\n          fileName =\n            fileName || disposition[`filename*`] || disposition[`filename`] || res.headers.get('filename') || res.headers.get('x-filename');\n          saveAs(res.body!, decodeURI(fileName as string));\n          this.success.emit(res);\n        },\n        err => this.error.emit(err),\n        () => this.setDisabled(false),\n      );\n  }\n}\n","import { CommonModule } from '@angular/common';\nimport { NgModule } from '@angular/core';\nimport { AlainThemeModule } from '@delon/theme';\n\nimport { DownFileDirective } from './down-file.directive';\n\nconst DIRECTIVES = [DownFileDirective];\n\n@NgModule({\n  imports: [CommonModule, AlainThemeModule],\n  declarations: [...DIRECTIVES],\n  exports: [...DIRECTIVES],\n})\nexport class DownFileModule {}\n"],"names":[],"mappings":"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"}