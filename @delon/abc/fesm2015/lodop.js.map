{"version":3,"file":"lodop.js.map","sources":["ng://@delon/abc/lodop/lodop.config.ts","ng://@delon/abc/lodop/lodop.service.ts","ng://@delon/abc/lodop/lodop.module.ts"],"sourcesContent":["export class LodopConfig {\r\n  /**\r\n   * æ³¨åä¿¡æ¯ï¼ä¸»æ³¨åå·\r\n   */\r\n  license: string;\r\n  /**\r\n   * æ³¨åä¿¡æ¯ï¼éå æ³¨åå·A\r\n   */\r\n  licenseA: string;\r\n  /**\r\n   * æ³¨åä¿¡æ¯ï¼éå æ³¨åå·B\r\n   */\r\n  licenseB?: string;\r\n  /**\r\n   * æ³¨åä¿¡æ¯ï¼æ³¨ååä½åç§°\r\n   */\r\n  companyName?: string;\r\n  /**\r\n   * Lodop è¿ç¨èæ¬URLå°åï¼**æ³¨æ**å¡å¿ä½¿ç¨ `name` å±æ§æå®åéå¼\r\n   *\r\n   * - http://localhost:18000/CLodopfuncs.js\r\n   * - https://localhost:8443/CLodopfuncs.js [é»è®¤]\r\n   */\r\n  url?: string;\r\n  /**\r\n   * Lodop åéåï¼é»è®¤ï¼`CLODOP`\r\n   */\r\n  name?: string;\r\n  /**\r\n   * æ£æ¥æ¬¡æ°ï¼é»è®¤ `100`ï¼å½æ£æ¥è¶è¿æ¶è§ä¸ºå¼å¸¸ï¼è¿æ¯å ä¸º Lodop éè¦è¿æ¥ WebSocket\r\n   */\r\n  checkMaxCount?: number;\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\nimport { Observable, of, Subject } from 'rxjs';\r\n\r\nimport { LazyService } from '@delon/util';\r\n\r\nimport { Lodop, LodopResult, LodopPrintResult } from './lodop.types';\r\nimport { LodopConfig } from './lodop.config';\r\n\r\n// TODO: zone\r\n@Injectable()\r\nexport class LodopService implements OnDestroy {\r\n  private _cog: LodopConfig;\r\n  private pending = false;\r\n  private _lodop: Lodop = null;\r\n  private _init: Subject<LodopResult> = new Subject<LodopResult>();\r\n  private _events: Subject<LodopPrintResult> = new Subject<LodopPrintResult>();\r\n\r\n  constructor(private defCog: LodopConfig, private scriptSrv: LazyService) {\r\n    this.cog = defCog;\r\n  }\r\n\r\n  /**\r\n   * è·åæéæ°è®¾ç½®éç½®\r\n   *\r\n   * **æ³¨ï¼**éæ°è®¾ç½®ä¼åç½®éæ°å è½½èæ¬èµæº\r\n   */\r\n  get cog() {\r\n    return this._cog;\r\n  }\r\n  set cog(value: LodopConfig) {\r\n    this._cog = Object.assign(\r\n      {\r\n        url: 'https://localhost:8443/CLodopfuncs.js',\r\n        name: 'CLODOP',\r\n        companyName: '',\r\n        checkMaxCount: 100,\r\n      },\r\n      this.defCog,\r\n      value,\r\n    );\r\n  }\r\n\r\n  /** äºä»¶åæ´éç¥ */\r\n  get events(): Observable<LodopPrintResult> {\r\n    return this._events.asObservable();\r\n  }\r\n\r\n  private check() {\r\n    if (!this._lodop) throw new Error(`è¯·å¡å¿åè°ç¨ lodop è·åå¯¹è±¡`);\r\n  }\r\n\r\n  private request(): void {\r\n    this.pending = true;\r\n\r\n    const url = `${this.cog.url}?name=${this.cog.name}`;\r\n    let checkMaxCount = this.cog.checkMaxCount;\r\n    const onResolve = (status, error?: any) => {\r\n      this._init.next({\r\n        ok: status === 'ok',\r\n        status,\r\n        error,\r\n        lodop: this._lodop,\r\n      });\r\n    };\r\n    const checkStatus = () => {\r\n      --checkMaxCount;\r\n      if (this._lodop.webskt && this._lodop.webskt.readyState === 1) {\r\n        onResolve('ok');\r\n      } else {\r\n        if (checkMaxCount < 0) {\r\n          onResolve('check-limit');\r\n          return;\r\n        }\r\n        setTimeout(() => checkStatus(), 100);\r\n      }\r\n    };\r\n\r\n    this.scriptSrv.loadScript(url).then((res) => {\r\n      if (res.status !== 'ok') {\r\n        this.pending = false;\r\n        onResolve('script-load-error', res[0]);\r\n        return;\r\n      }\r\n      this._lodop =\r\n        window.hasOwnProperty(this.cog.name) &&\r\n        (window[this.cog.name] as Lodop);\r\n      if (this._lodop === null) {\r\n        onResolve('load-variable-name-error', { name: this.cog.name });\r\n        return;\r\n      }\r\n      this._lodop.SET_LICENSES(\r\n        this.cog.companyName,\r\n        this.cog.license,\r\n        this.cog.licenseA,\r\n        this.cog.licenseB,\r\n      );\r\n      checkStatus();\r\n    });\r\n  }\r\n\r\n  /** éç½® lodop å¯¹è±¡ */\r\n  reset() {\r\n    this._lodop = null;\r\n    this.pending = false;\r\n    this.request();\r\n  }\r\n\r\n  /** è·å lodop å¯¹è±¡ */\r\n  get lodop(): Observable<LodopResult> {\r\n    if (this._lodop) return of(<LodopResult>{ ok: true, lodop: this._lodop });\r\n    if (this.pending) return this._init.asObservable();\r\n\r\n    this.request();\r\n\r\n    return this._init.asObservable();\r\n  }\r\n\r\n  /** è·åæå°æºåè¡¨ */\r\n  get printer(): string[] {\r\n    this.check();\r\n    const ret: string[] = [];\r\n    const count = this._lodop.GET_PRINTER_COUNT();\r\n    for (let index = 0; index < count; index++) {\r\n      ret.push(this._lodop.GET_PRINTER_NAME(index));\r\n    }\r\n    return ret;\r\n  }\r\n\r\n  /**\r\n   * éå ä»£ç è³ `lodop` å¯¹è±¡ä¸ï¼å­ç¬¦ä¸²ç±»æ¯æ `{{key}}` çå¨æåæ°\r\n   *\r\n   * **æ³¨ï¼** ä»£ç æ¯ææå°è®¾è®¡æäº§çå­ç¬¦ä¸²æ°æ®\r\n   *\r\n   * @param code ä»£ç \r\n   * @param contextObj å¨æåæ°ä¸ä¸æå¯¹è±¡\r\n   * @param parser èªå®ä¹è§£æè¡¨è¾¾å¼ï¼é»è®¤ï¼`/LODOP\\.([^(]+)\\(([^\\n]+)\\);/i`\r\n   */\r\n  attachCode(code: string, contextObj?: Object, parser?: RegExp): void {\r\n    this.check();\r\n    if (!parser) parser = /LODOP\\.([^(]+)\\(([^\\n]+)\\);/i;\r\n    code.split('\\n').forEach(line => {\r\n      const res = parser.exec(line.trim());\r\n      if (!res) return;\r\n      const fn = this._lodop[res[1]];\r\n      if (fn) {\r\n        let arr: Array<any>;\r\n        try {\r\n          const fakeFn = new Function(`return [${res[2]}]`);\r\n          arr = fakeFn() as any[];\r\n        } catch {}\r\n\r\n        if (Array.isArray(arr) && contextObj) {\r\n          for (let i = 0; i < arr.length; i++) {\r\n            if (typeof arr[i] === 'string') {\r\n              arr[i] = arr[i].replace(\r\n                /{{(.*?)}}/g,\r\n                (match, key) => contextObj[key.trim()] || '',\r\n              );\r\n            }\r\n          }\r\n        }\r\n        fn.apply(this._lodop, arr);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * æå¼æå°è®¾è®¡å³é­åèªå¨è¿åä»£ç \r\n   *\r\n   * **æ³¨ï¼** èªå¨çå¬ `On_Return` äºä»¶ï¼è¿è¡åä¼ç§»é¤\r\n   */\r\n  design(): Promise<string> {\r\n    this.check();\r\n    const tid = this._lodop.PRINT_DESIGN();\r\n    return new Promise(resolve => {\r\n      this._lodop.On_Return = (taskID: string, value: boolean | string) => {\r\n        if (tid !== taskID) return;\r\n        this._lodop.On_Return = null;\r\n        resolve('' + value);\r\n      };\r\n    });\r\n  }\r\n\r\n  private printBuffer: any[] = [];\r\n  private printDo() {\r\n    const data = this.printBuffer.shift();\r\n    if (!data) return;\r\n    this.attachCode(data.code, data.item, data.parser);\r\n    const tid = this._lodop.PRINT();\r\n    this._lodop.On_Return = (taskID: string, value: boolean | string) => {\r\n      if (tid !== taskID) return;\r\n      this._lodop.On_Return = null;\r\n      this._events.next(\r\n        Object.assign(\r\n          <LodopPrintResult>{\r\n            ok: value === true,\r\n            error: value === true ? null : value,\r\n          },\r\n          data,\r\n        ),\r\n      );\r\n      this.printDo();\r\n    };\r\n  }\r\n\r\n  /**\r\n   * ç«å³æå°ï¼ä¸è¬ç¨äºæ¹éå¥æ\r\n   *\r\n   * @param code ä»£ç \r\n   * @param contextObj å¨æåæ°ä¸ä¸æå¯¹è±¡\r\n   * @param parser èªå®ä¹è§£æè¡¨è¾¾å¼ï¼é»è®¤ï¼`/LODOP\\.([^(]+)\\(([^\\n]+)\\);/i`\r\n   */\r\n  print(code: string, contextObj: Object | Object[], parser?: RegExp): void {\r\n    this.check();\r\n    if (contextObj) {\r\n      this.printBuffer.push(\r\n        ...(Array.isArray(contextObj) ? contextObj : [contextObj]).map(item => {\r\n          return { code, parser, item };\r\n        }),\r\n      );\r\n    }\r\n    this.printDo();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this._init.unsubscribe();\r\n    this._events.unsubscribe();\r\n  }\r\n}\r\n","import { ModuleWithProviders, NgModule } from '@angular/core';\r\nimport { DelonUtilModule } from '@delon/util';\r\n\r\nimport { LodopConfig } from './lodop.config';\r\nimport { LodopService } from './lodop.service';\r\n\r\n@NgModule({\r\n  imports: [DelonUtilModule],\r\n})\r\nexport class LodopModule {\r\n  static forRoot(): ModuleWithProviders {\r\n    return {\r\n      ngModule: LodopModule,\r\n      providers: [LodopService, LodopConfig],\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}
