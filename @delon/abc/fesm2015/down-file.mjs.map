{"version":3,"file":"down-file.mjs","sources":["../../../../packages/abc/down-file/down-file.directive.ts","../../../../packages/abc/down-file/down-file.module.ts","../../../../packages/abc/down-file/down-file.ts"],"sourcesContent":["import { HttpResponse } from '@angular/common/http';\nimport { Directive, ElementRef, EventEmitter, Input, Output } from '@angular/core';\nimport { finalize } from 'rxjs/operators';\n\nimport { saveAs } from 'file-saver';\n\nimport { _HttpClient } from '@delon/theme';\nimport type { NzSafeAny } from 'ng-zorro-antd/core/types';\n\n@Directive({\n  selector: '[down-file]',\n  exportAs: 'downFile',\n  host: {\n    '(click)': '_click($event)'\n  }\n})\nexport class DownFileDirective {\n  private isFileSaverSupported = true;\n  @Input('http-data') httpData: NzSafeAny;\n  @Input('http-body') httpBody: NzSafeAny;\n  @Input('http-method') httpMethod: string = 'get';\n  @Input('http-url') httpUrl!: string;\n  @Input('file-name') fileName?: string | ((rep: HttpResponse<Blob>) => string);\n  @Input() pre?: (ev: MouseEvent) => Promise<boolean>;\n  @Output() readonly success = new EventEmitter<HttpResponse<Blob>>();\n  @Output() readonly error = new EventEmitter<NzSafeAny>();\n\n  private getDisposition(data: string | null): NzSafeAny {\n    const arr: Array<Record<string, string>> = (data || '')\n      .split(';')\n      .filter(i => i.includes('='))\n      .map(v => {\n        const strArr = v.split('=');\n        const utfId = `UTF-8''`;\n        let value = strArr[1];\n        if (value.startsWith(utfId)) value = value.substring(utfId.length);\n        return { [strArr[0].trim()]: value };\n      });\n    return arr.reduce((_o, item) => item, {});\n  }\n\n  constructor(private el: ElementRef<HTMLButtonElement>, private _http: _HttpClient) {\n    let isFileSaverSupported = false;\n    try {\n      isFileSaverSupported = !!new Blob();\n    } catch {}\n    this.isFileSaverSupported = isFileSaverSupported;\n    if (!isFileSaverSupported) {\n      el.nativeElement.classList.add(`down-file__not-support`);\n    }\n  }\n\n  private setDisabled(status: boolean): void {\n    const el = this.el.nativeElement;\n    el.disabled = status;\n    el.classList[status ? 'add' : 'remove'](`down-file__disabled`);\n  }\n\n  async _click(ev: MouseEvent): Promise<void> {\n    if (!this.isFileSaverSupported || (typeof this.pre === 'function' && !(await this.pre(ev)))) {\n      ev.stopPropagation();\n      ev.preventDefault();\n      return;\n    }\n    this.setDisabled(true);\n    this._http\n      .request(this.httpMethod, this.httpUrl, {\n        params: this.httpData || {},\n        responseType: 'blob',\n        observe: 'response',\n        body: this.httpBody\n      })\n      .pipe(finalize(() => this.setDisabled(false)))\n      .subscribe({\n        next: (res: HttpResponse<Blob>) => {\n          if (res.status !== 200 || res.body!.size <= 0) {\n            this.error.emit(res);\n            return;\n          }\n          const disposition = this.getDisposition(res.headers.get('content-disposition'));\n          let fileName = this.fileName;\n          if (typeof fileName === 'function') fileName = fileName(res);\n          fileName =\n            fileName ||\n            disposition[`filename*`] ||\n            disposition[`filename`] ||\n            res.headers.get('filename') ||\n            res.headers.get('x-filename');\n          saveAs(res.body!, decodeURI(fileName as string));\n          this.success.emit(res);\n        },\n        error: err => this.error.emit(err)\n      });\n  }\n}\n","import { CommonModule } from '@angular/common';\nimport { NgModule } from '@angular/core';\n\nimport { AlainThemeModule } from '@delon/theme';\n\nimport { DownFileDirective } from './down-file.directive';\n\nconst DIRECTIVES = [DownFileDirective];\n\n@NgModule({\n  imports: [CommonModule, AlainThemeModule],\n  declarations: [...DIRECTIVES],\n  exports: [...DIRECTIVES]\n})\nexport class DownFileModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":";;;;;;;;;MAgBa,iBAAiB,CAAA;IAyB5B,WAAoB,CAAA,EAAiC,EAAU,KAAkB,EAAA;AAA7D,QAAA,IAAE,CAAA,EAAA,GAAF,EAAE,CAA+B;AAAU,QAAA,IAAK,CAAA,KAAA,GAAL,KAAK,CAAa;AAxBzE,QAAA,IAAoB,CAAA,oBAAA,GAAG,IAAI,CAAC;AAGd,QAAA,IAAU,CAAA,UAAA,GAAW,KAAK,CAAC;AAI9B,QAAA,IAAA,CAAA,OAAO,GAAG,IAAI,YAAY,EAAsB,CAAC;AACjD,QAAA,IAAA,CAAA,KAAK,GAAG,IAAI,YAAY,EAAa,CAAC;QAiBvD,IAAI,oBAAoB,GAAG,KAAK,CAAC;QACjC,IAAI;AACF,YAAA,oBAAoB,GAAG,CAAC,CAAC,IAAI,IAAI,EAAE,CAAC;AACrC,SAAA;AAAC,QAAA,OAAA,EAAA,EAAM,GAAE;AACV,QAAA,IAAI,CAAC,oBAAoB,GAAG,oBAAoB,CAAC;QACjD,IAAI,CAAC,oBAAoB,EAAE;YACzB,EAAE,CAAC,aAAa,CAAC,SAAS,CAAC,GAAG,CAAC,CAAwB,sBAAA,CAAA,CAAC,CAAC;AAC1D,SAAA;KACF;AAvBO,IAAA,cAAc,CAAC,IAAmB,EAAA;AACxC,QAAA,MAAM,GAAG,GAAkC,CAAC,IAAI,IAAI,EAAE;aACnD,KAAK,CAAC,GAAG,CAAC;aACV,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;aAC5B,GAAG,CAAC,CAAC,IAAG;YACP,MAAM,MAAM,GAAG,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAC5B,MAAM,KAAK,GAAG,CAAA,OAAA,CAAS,CAAC;AACxB,YAAA,IAAI,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;AACtB,YAAA,IAAI,KAAK,CAAC,UAAU,CAAC,KAAK,CAAC;gBAAE,KAAK,GAAG,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;AACnE,YAAA,OAAO,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,GAAG,KAAK,EAAE,CAAC;AACvC,SAAC,CAAC,CAAC;AACL,QAAA,OAAO,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,EAAE,IAAI,KAAK,IAAI,EAAE,EAAE,CAAC,CAAC;KAC3C;AAaO,IAAA,WAAW,CAAC,MAAe,EAAA;AACjC,QAAA,MAAM,EAAE,GAAG,IAAI,CAAC,EAAE,CAAC,aAAa,CAAC;AACjC,QAAA,EAAE,CAAC,QAAQ,GAAG,MAAM,CAAC;AACrB,QAAA,EAAE,CAAC,SAAS,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ,CAAC,CAAC,CAAA,mBAAA,CAAqB,CAAC,CAAC;KAChE;AAEK,IAAA,MAAM,CAAC,EAAc,EAAA;;YACzB,IAAI,CAAC,IAAI,CAAC,oBAAoB,KAAK,OAAO,IAAI,CAAC,GAAG,KAAK,UAAU,IAAI,EAAE,MAAM,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE;gBAC3F,EAAE,CAAC,eAAe,EAAE,CAAC;gBACrB,EAAE,CAAC,cAAc,EAAE,CAAC;gBACpB,OAAO;AACR,aAAA;AACD,YAAA,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;AACvB,YAAA,IAAI,CAAC,KAAK;iBACP,OAAO,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,EAAE;AACtC,gBAAA,MAAM,EAAE,IAAI,CAAC,QAAQ,IAAI,EAAE;AAC3B,gBAAA,YAAY,EAAE,MAAM;AACpB,gBAAA,OAAO,EAAE,UAAU;gBACnB,IAAI,EAAE,IAAI,CAAC,QAAQ;aACpB,CAAC;AACD,iBAAA,IAAI,CAAC,QAAQ,CAAC,MAAM,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC;AAC7C,iBAAA,SAAS,CAAC;AACT,gBAAA,IAAI,EAAE,CAAC,GAAuB,KAAI;AAChC,oBAAA,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,IAAI,GAAG,CAAC,IAAK,CAAC,IAAI,IAAI,CAAC,EAAE;AAC7C,wBAAA,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;wBACrB,OAAO;AACR,qBAAA;AACD,oBAAA,MAAM,WAAW,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAC,CAAC;AAChF,oBAAA,IAAI,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;oBAC7B,IAAI,OAAO,QAAQ,KAAK,UAAU;AAAE,wBAAA,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC;oBAC7D,QAAQ;wBACN,QAAQ;4BACR,WAAW,CAAC,WAAW,CAAC;4BACxB,WAAW,CAAC,UAAU,CAAC;AACvB,4BAAA,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC;AAC3B,4BAAA,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;oBAChC,MAAM,CAAC,GAAG,CAAC,IAAK,EAAE,SAAS,CAAC,QAAkB,CAAC,CAAC,CAAC;AACjD,oBAAA,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;iBACxB;AACD,gBAAA,KAAK,EAAE,GAAG,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC;AACnC,aAAA,CAAC,CAAC;SACN,CAAA,CAAA;AAAA,KAAA;;+GA7EU,iBAAiB,EAAA,IAAA,EAAA,CAAA,EAAA,KAAA,EAAA,EAAA,CAAA,UAAA,EAAA,EAAA,EAAA,KAAA,EAAA,EAAA,CAAA,WAAA,EAAA,CAAA,EAAA,MAAA,EAAA,EAAA,CAAA,eAAA,CAAA,SAAA,EAAA,CAAA,CAAA;mGAAjB,iBAAiB,EAAA,QAAA,EAAA,aAAA,EAAA,MAAA,EAAA,EAAA,QAAA,EAAA,CAAA,WAAA,EAAA,UAAA,CAAA,EAAA,QAAA,EAAA,CAAA,WAAA,EAAA,UAAA,CAAA,EAAA,UAAA,EAAA,CAAA,aAAA,EAAA,YAAA,CAAA,EAAA,OAAA,EAAA,CAAA,UAAA,EAAA,SAAA,CAAA,EAAA,QAAA,EAAA,CAAA,WAAA,EAAA,UAAA,CAAA,EAAA,GAAA,EAAA,KAAA,EAAA,EAAA,OAAA,EAAA,EAAA,OAAA,EAAA,SAAA,EAAA,KAAA,EAAA,OAAA,EAAA,EAAA,IAAA,EAAA,EAAA,SAAA,EAAA,EAAA,OAAA,EAAA,gBAAA,EAAA,EAAA,EAAA,QAAA,EAAA,CAAA,UAAA,CAAA,EAAA,QAAA,EAAA,EAAA,EAAA,CAAA,CAAA;4FAAjB,iBAAiB,EAAA,UAAA,EAAA,CAAA;kBAP7B,SAAS;AAAC,YAAA,IAAA,EAAA,CAAA;AACT,oBAAA,QAAQ,EAAE,aAAa;AACvB,oBAAA,QAAQ,EAAE,UAAU;AACpB,oBAAA,IAAI,EAAE;AACJ,wBAAA,SAAS,EAAE,gBAAgB;AAC5B,qBAAA;iBACF,CAAA;2HAGqB,QAAQ,EAAA,CAAA;sBAA3B,KAAK;uBAAC,WAAW,CAAA;gBACE,QAAQ,EAAA,CAAA;sBAA3B,KAAK;uBAAC,WAAW,CAAA;gBACI,UAAU,EAAA,CAAA;sBAA/B,KAAK;uBAAC,aAAa,CAAA;gBACD,OAAO,EAAA,CAAA;sBAAzB,KAAK;uBAAC,UAAU,CAAA;gBACG,QAAQ,EAAA,CAAA;sBAA3B,KAAK;uBAAC,WAAW,CAAA;gBACT,GAAG,EAAA,CAAA;sBAAX,KAAK;gBACa,OAAO,EAAA,CAAA;sBAAzB,MAAM;gBACY,KAAK,EAAA,CAAA;sBAAvB,MAAM;;;AClBT,MAAM,UAAU,GAAG,CAAC,iBAAiB,CAAC,CAAC;MAO1B,cAAc,CAAA;;4GAAd,cAAc,EAAA,IAAA,EAAA,EAAA,EAAA,MAAA,EAAA,EAAA,CAAA,eAAA,CAAA,QAAA,EAAA,CAAA,CAAA;AAAd,cAAA,CAAA,IAAA,GAAA,EAAA,CAAA,mBAAA,CAAA,EAAA,UAAA,EAAA,QAAA,EAAA,OAAA,EAAA,SAAA,EAAA,QAAA,EAAA,EAAA,EAAA,IAAA,EAAA,cAAc,iBAPP,iBAAiB,CAAA,EAAA,OAAA,EAAA,CAGzB,YAAY,EAAE,gBAAgB,aAHtB,iBAAiB,CAAA,EAAA,CAAA,CAAA;AAOxB,cAAA,CAAA,IAAA,GAAA,EAAA,CAAA,mBAAA,CAAA,EAAA,UAAA,EAAA,QAAA,EAAA,OAAA,EAAA,SAAA,EAAA,QAAA,EAAA,EAAA,EAAA,IAAA,EAAA,cAAc,EAJhB,OAAA,EAAA,CAAA,CAAC,YAAY,EAAE,gBAAgB,CAAC,CAAA,EAAA,CAAA,CAAA;4FAI9B,cAAc,EAAA,UAAA,EAAA,CAAA;kBAL1B,QAAQ;AAAC,YAAA,IAAA,EAAA,CAAA;AACR,oBAAA,OAAO,EAAE,CAAC,YAAY,EAAE,gBAAgB,CAAC;AACzC,oBAAA,YAAY,EAAE,CAAC,GAAG,UAAU,CAAC;AAC7B,oBAAA,OAAO,EAAE,CAAC,GAAG,UAAU,CAAC;iBACzB,CAAA;;;ACbD;;AAEG;;;;"}